<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Information Chatbot</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1, h2 {
            color: #444;
            text-align: center;
        }

        .form-section, .chat-section {
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            margin-top: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button:disabled:hover {
            background-color: #cccccc;
        }

        #status {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }

        .chat-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 6px;
        }
        .user-message {
            background-color: #e1f5fe;
            text-align: right;
        }
        .bot-message {
            background-color: #e8eaf6;
        }
        .bot-message pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-bottom: -1px;
        }
        .tab.active {
            border-color: #ddd;
            border-bottom: 1px solid white;
            border-radius: 4px 4px 0 0;
            background-color: #fff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

    </style>
</head>
<body>

    <h1>Lab Information Chatbot</h1>

    <div class="container">
        <h2>1. Lab Setup</h2>
        <div class="form-section">
            <div class="input-group">
                <label for="setup_lab_id">Lab ID</label>
                <input type="text" id="setup_lab_id" placeholder="e.g., ai-robotics-lab">
            </div>
            <div class="input-group">
                <label for="intro_urls">Introduction URLs (comma-separated)</label>
                <input type="text" id="intro_urls" placeholder="e.g., http://lab.com/intro, http://lab.com/members">
            </div>
            <div class="input-group">
                <label for="publication_url">Publication URL</label>
                <input type="text" id="publication_url" placeholder="e.g., http://lab.com/publications">
            </div>

            <button id="load_button" onclick="loadLabInfo()">1. Load Lab Info</button>
            <button id="embed_button" onclick="createEmbedding()">2. Create Embedding</button>
            
            <div id="status"></div>
        </div>
    </div>

    <div class="container">
        <h2>2. Ask Questions</h2>
        <div class="chat-section">
            <div class="input-group">
                <label for="qa_lab_id">Lab ID for Q&A</label>
                <input type="text" id="qa_lab_id" placeholder="Enter the ID of the lab you want to ask about">
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('general')">General Q&A</div>
                <div class="tab" onclick="switchTab('job')">Job Q&A</div>
            </div>

            <div id="chat-container" class="chat-container"></div>

            <div id="general" class="tab-content active">
                <textarea id="general_question" rows="3" placeholder="Ask a general question about the lab..."></textarea>
                <button onclick="askGeneral()">Send</button>
            </div>

            <div id="job" class="tab-content">
                <textarea id="job_info" rows="3" placeholder="Enter job description..."></textarea>
                <textarea id="user_info" rows="3" placeholder="Enter your skills and experience..."></textarea>
                <textarea id="job_question" rows="2" placeholder="Ask a job-related question..."></textarea>
                <button onclick="askJob()">Send</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const setupLabIdInput = document.getElementById('setup_lab_id');
        const qaLabIdInput = document.getElementById('qa_lab_id');
        const introUrlsInput = document.getElementById('intro_urls');
        const publicationUrlInput = document.getElementById('publication_url');
        const statusDiv = document.getElementById('status');
        const chatContainer = document.getElementById('chat-container');
        const loadButton = document.getElementById('load_button');
        const embedButton = document.getElementById('embed_button');

        // --- Helper to get Lab Data ---
        function getLabDataFromForm() {
            const lab_id = setupLabIdInput.value.trim();
            const intro_urls = introUrlsInput.value.split(',').map(url => url.trim()).filter(url => url);
            const publication_url = publicationUrlInput.value.trim();
            
            if (!lab_id || intro_urls.length === 0 || !publication_url) {
                statusDiv.textContent = 'Please fill in all lab setup fields.';
                statusDiv.style.color = 'red';
                return null;
            }
            return { lab_id, intro_urls, publication_url };
        }

        // --- Setup Step 1: Load Info ---
        async function loadLabInfo() {
            const labData = getLabDataFromForm();
            if (!labData) return;

            loadButton.disabled = true;
            embedButton.disabled = true;
            statusDiv.textContent = `Loading lab info for '${labData.lab_id}'...`;
            statusDiv.style.color = 'blue';

            try {
                const response = await fetch('/load_lab_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(labData)
                });
                if (!response.ok) throw new Error(`Failed to load lab info (status: ${response.status}).`);
                
                const result = await response.json();
                statusDiv.textContent = `Step 1 complete for '${result.lab_id}'. Ready for Step 2.`;
                statusDiv.style.color = 'green';
                embedButton.disabled = false; // Enable next step
            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.style.color = 'red';
            } finally {
                loadButton.disabled = false;
            }
        }

        // --- Setup Step 2: Create Embedding ---
        async function createEmbedding() {
            const labData = getLabDataFromForm();
            if (!labData) return;

            embedButton.disabled = true;
            statusDiv.textContent = `Creating embedding for '${labData.lab_id}'...`;
            statusDiv.style.color = 'blue';

            try {
                const response = await fetch('/create_embedding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(labData)
                });
                if (!response.ok) throw new Error(`Failed to create embedding (status: ${response.status}).`);

                const result = await response.json();
                statusDiv.textContent = `Embedding created for '${result.lab_id}'. You can now ask questions about it below.`;
                statusDiv.style.color = 'green';
            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.style.color = 'red';
            } finally {
                // Keep it enabled for potential re-embedding
                embedButton.disabled = false; 
            }
        }

        // --- Tab Switching Logic ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // --- Display Messages in Chat ---
        function addMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', `${sender}-message`);
            
            if (sender === 'bot') {
                const pre = document.createElement('pre');
                pre.textContent = message;
                messageDiv.appendChild(pre);
            } else {
                messageDiv.textContent = message;
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // --- General Q&A ---
        async function askGeneral() {
            const lab_id = qaLabIdInput.value.trim();
            const questionInput = document.getElementById('general_question');
            const question = questionInput.value.trim();

            if (!lab_id) {
                alert('Please enter the Lab ID in the "Lab ID for Q&A" field.');
                qaLabIdInput.focus();
                return;
            }
            if (!question) {
                alert('Please enter a question.');
                questionInput.focus();
                return;
            }

            addMessage(question, 'user');
            questionInput.value = '';

            try {
                addMessage("Thinking...", 'bot');
                const response = await fetch('/chat_general', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lab_id, question })
                });

                chatContainer.removeChild(chatContainer.lastChild);

                if (!response.ok) throw new Error(`Network response was not ok (status: ${response.status}).`);

                const result = await response.json();
                addMessage(result.answer, 'bot');
            } catch (error) {
                addMessage(`Error: ${error.message}`, 'bot');
            }
        }
        
        // --- Job Q&A ---
        async function askJob() {
            const lab_id = qaLabIdInput.value.trim();
            const jobInfoInput = document.getElementById('job_info');
            const userInfoInput = document.getElementById('user_info');
            const questionInput = document.getElementById('job_question');

            const job_info = jobInfoInput.value.trim();
            const user_info = userInfoInput.value.trim();
            const question = questionInput.value.trim();

            if (!lab_id) {
                alert('Please enter the Lab ID in the "Lab ID for Q&A" field.');
                qaLabIdInput.focus();
                return;
            }
            if (!job_info || !user_info || !question) {
                alert('Please fill in the job info, user info, and your question.');
                return;
            }

            const userQuery = `Job Question: ${question}\n\nJob Info:\n${job_info}\n\nMy Info:\n${user_info}`;
            addMessage(userQuery, 'user');
            questionInput.value = '';

            try {
                addMessage("Thinking...", 'bot');
                const response = await fetch('/chat_job', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lab_id, question, job_info, user_info })
                });

                chatContainer.removeChild(chatContainer.lastChild);

                if (!response.ok) throw new Error(`Network response was not ok (status: ${response.status}).`);
                
                const result = await response.json();
                addMessage(result.answer, 'bot');
            } catch (error) {
                addMessage(`Error: ${error.message}`, 'bot');
            }
        }
    </script>
</body>
</html>